package pong;

import gui.NNEye;
import gui.NNSimulationController;
import gui.NNWindow;

import java.awt.event.KeyEvent;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import neuralnet.NNProperties;
import neuralnet.net.LayeredNetwork;
import neuralnet.net.NeuralNet;
import pong.core.PongPlayer;
import pong.core.VisualPongPlayer;
import pong.core.pongs.FootballPong;
import pong.core.pongs.Pong;
import pong.core.pongs.TwoPlayerPong;
import pong.ui.PongFrame;

public class PongController extends NNSimulationController  {	
	private static final int ONE_PLAYER = 1;
	private static final int TWO_PLAYER = 2;
	private static final int FOOTBALL = 3;
	private static final int VISUAL = 4;	
	private static final int GEN = -1;
	private static final int BACKP = -3;
	private static int NONE = -5;	
	
	private List<PongPlayer> pongPlayers;
	private List<Pong> pongs;
	private int nnType;

	{
		pongs = new ArrayList<Pong>();
		pongPlayers = new ArrayList<PongPlayer>();
	}
	
	public PongController(NNProperties p,  double... weights) {
		this(p);		
		for (PongPlayer player : pongPlayers) 	
			player.getBrain().getGenome().updateWeights(weights);
	}
	
	public PongController(NNProperties p) {
		super(p);			
		nnType = p.asInt("nnType");
	
		if (nnType == NONE)
			initPongs();	
		else {
			if (nnType == GEN)
				initGeneticApproach();
			if (nnType == BACKP)
				runBackPropagationApproach();				
		}		
		
		initUI();
	}
	
	private void runBackPropagationApproach() {		
		initPongs();	
		if (getProps().asInt("mode") == ONE_PLAYER)
			initPlayers(1);
		else
			initPlayers(2);
	}

	private void initGeneticApproach() {		
		initPongs();		
		initPlayers(2);	
	}

	private void initPlayers(int playersPerPong) {
		NNProperties props = getProps();
		for (Pong pong : pongs) {		
			for (int i = 0; i < playersPerPong; i++) {				
				PongPlayer player = new PongPlayer(pong, pong.getBars().get(i), props.instantiateNet());
				if (props.asInt("mode") == VISUAL)
					player =  new VisualPongPlayer(pong, pong.getBars().get(i), props.instantiateNet());
				pongPlayers.add(player);
			}
		}		
	}

	private void initPongs() {
		NNProperties props = getProps();
		int nrOfPongs = props.asInt("nrOfPongs");
		int mode = props.asInt("mode");
		
		for (int i = 0; i < nrOfPongs; i++) {
			
			Pong pong = new Pong();				
			if (mode == TWO_PLAYER) 	
				pong = new TwoPlayerPong();			
			if (mode == FOOTBALL) 
				pong = new FootballPong();			
			
			pongs.add(pong);
			pong.start();
		}	
	}
	
	private void initUI() {
		LayeredNetwork net = getNets().get(0);
		net.getAllLayer().forEach(l ->  new NNEye(net, l, 10));	
		List<LayeredNetwork> brains = new ArrayList<LayeredNetwork>();
		getNets().forEach(n -> brains.add((LayeredNetwork)n));
		NNWindow r = new NNWindow(brains);		
	}

	@Override
	public List<LayeredNetwork> getNets() {
		List<LayeredNetwork> net = new ArrayList<LayeredNetwork>();
		pongPlayers.forEach(p -> net.add(p.getBrain()));
		return net;
	}
	
	@Override
	public void keyPressed(KeyEvent e) {		
		super.keyPressed(e);
		
		switch (e.getKeyChar()) {
			case 'w':
				pongs.forEach(p -> p.getBar().move(-1));
				break;
			case 's':
				pongs.forEach(p -> p.getBar().move(1));	
				break;
			case 'i':
				pongs.forEach(p -> ((TwoPlayerPong)p).getSecondBar().move(-1));
				break;
			case 'k':
				pongs.forEach(p -> ((TwoPlayerPong)p).getSecondBar().move(1));
		}
	}

	@Override
	protected void doStep(boolean generationChange) {		
		for (Pong pong : pongs) {
			pong.moveBall();
		}
		for (PongPlayer player : pongPlayers) {			
			player.movePlayer();		
		}		
	}
	

	
	public static void main(String[] args) throws IOException {
		double[] genes = 
		{ 0.7461933931968494, 0.44586295883285654, 0.5779152933045961, 0.23862597076354747, 0.20348332181566697, 
		  0.7123103961148585, 0.7864703215961889, 0.5753459740484409, 0.8544160607253535, 0.9363106177963056, 
		  0.5119890442379034, 0.9771203457758065, 0.5876662393819502, 0.14184341672072223, 0.7992181072810124, 
		  0.17800442468115357, 0.8771368397674336, 0.9180129214706095, 0.06761983062662306, 0.9629753965086001, 
		  0.33762543255137223, 0.8734058433745105, 0.23345860125546242, 0.5125609573050514, 0.9684550686081084, 
		  0.836164960232506, 0.9152289261043806, 0.037624398472229065, 0.371285714918098, 0.37585321778742947, 
		  0.7503197470021885, 0.8283338251071831, 0.10584973656829115, 0.36444706037181734, 0.13886882101157433, 
		  0.6256411379496544, 0.5244603788486646, 0.7442641813169882, 0.36357279921216334, 0.9316264895007664, 
		  0.5410427963342068, 0.1918864809651835, 0.5111452151079744, 0.9320304373169347, 0.3875640397405858, 
		  0.05311604196039657, 0.9698697373579429, 0.5345039803309204, 0.1229600465057473, 0.5887089375693046, 
		  0.24541540401623071, 0.840234504012449, 0.3725690374281855, 0.5159849862844207, 0.07103659966040075, 
		  0.734270263211049, 0.8816947770249703, 0.8806485141961251, 0.406116770524563, 0.5352290819866166, 0.07490110041231553, 0.10599532875620854, 0.8520396527839058, 0.8067979904576937, 0.6345416135539841, 0.7079466276880871, 0.7327752198759628, 0.9903834848073707, 0.4071704722429919, 0.14413497190849806, 0.19335500519492982, 0.5295129234859084, 0.38247281645550907, 0.876263364051758, 0.191845220106884, 0.8555053521700852, 0.9588038016352051, 0.13755655208591228, 0.7370662754000278, 0.7708698239393712, 0.15403394910743123, 0.9857485475616983, 0.3154842268210247, 0.3399471468190975, 0.6686713095522869, -0.0019258945662812387, 0.8371522187248869, 0.11945346450315758, 0.826644752430976, 0.0192931958122207, 0.45405440023315097, 0.5526430101136409, -0.05928049878865338, 0.5195558957984463, 0.14147363672712596, 0.6734398448994537, 0.8245364509968609, 0.44096269760293694, 0.21413470437055673, 0.5018806017353543, 0.5119732235044958, -0.39184348440671524, 0.489107575176689, 0.3843125470989525, 0.10443104877361878, 0.26101586432391216, 0.487125882823641, -0.08438252085243489, 0.5085528551154406, 0.02530176322556169, -0.024705610966316894, 0.4261236913296807, 0.46535389166585656, -0.08286679299330384, 0.47420744514806085, -0.2686265158324917, 0.014385920144788535, 0.08772903671910859, 0.62720983087019, 0.1423789081361077
		};
		
		double[] genes2 = 
				
		{0.7464998865193126, 0.4452396199994173, 0.5781650222825617, 0.238817355882547, 0.20341793891916835, 0.7125705834760646, 
				0.7866684510604621, 0.5751185950898925, 0.8545182552421184, 0.9362943731071177, 0.5118438334129495, 0.9773554174540271,
				0.5879602500875252, 0.14155206664079942, 0.7994756733237858, 0.1775735622822653, 0.8768794063988561, 0.9180088890948827, 0.06802149174725619, 0.962990084528449, 0.6760252309536403, 0.30318341825743594, 0.4821509312339935, 0.7250731962786295, 0.9219605668442219, 1.1778602995593832, 1.1221235775866012, -0.18693156356502824, 0.45355526414100994, 0.3901454083403918, 0.6292848501010696, 1.0844181553282726, 0.436108533821788, 0.05781450685095771, 0.4140078698208556, 0.257816102636541, 0.22524157502599287, 0.7629531331219537, 0.8025258955943436, 0.9807254446747301, 0.5430029149438397, 0.17041845021359092, 0.5137685085771939, 0.9341748661876434, 0.38266866932878024, 0.05508387920674318, 0.9738329243844979, 0.5246766394595498, 0.12169932774892174, 0.5859113631908618, 0.23808908052085956, 0.8443745611679457, 0.3762231300006958, 0.5043587802562848, 0.07346062307708105, 0.7208422562643786, 0.8713654695897096, 0.8786423558222584, 0.4093222391565519, 0.5333168204158377, 0.10227683329823882, 0.05704704471428038, 0.8693611231190278, 0.82510755419498, 0.63462597525857, 0.7464694125334537, 0.7531870618134525, 0.9653588798892178, 0.40581025850745756, 0.1462556704674278, 0.18512273089669035, 0.5553914131558578, 0.4062202475305812, 0.8454481494982521, 0.21003112442331845, 0.8249891944351048, 0.9290298947700928, 0.14290917368279227, 0.7729420840057711, 0.781287534514714, -0.08915691282923714, 1.4440382120198247, 0.10642504889898874, 0.18386075735117746, 0.7390799310391541, -0.17815106708534176, 0.6739067861188118, 0.2863389425964258, 0.7077845408320862, 0.038063148983823396, 0.5827401520328321, 0.37436601215423737, -0.3153285091526074, 0.745525399939505, -0.08487550229683781, 0.9667832855883458, 1.0339110030097443, 0.4563151467153479, -0.1100896884396475, 0.5086150152098128, 0.5409512599931836, -0.9775690637123006, 0.3669491162732677, 0.3504391922551486, -0.01693209589698575, 0.716494166399359, 0.4191836670190509, -0.5110776409294624, 0.0013961197112144618, -0.0022457177830911817, -0.20838490638896426, 0.49562855598448924, 0.4434287472863226, 
				-0.6063916572555293, 0.3785265289164216, -0.6363266979676819, -0.5678480253882685, 0.0783589588855039, 0.7316422478877054, 0.19769632483191307};

			
		
		
		double[] tp1 = {0.3207239116628632, 0.9263950905115144, 0.603106010222353, 0.46204501076816734, 0.9538400968274301, 0.3137525806676611, 0.8395089818838815, 0.39354820052825845, 0.5333993685287489, 0.2902362357314256, 0.08945261470928807, 0.6614314581167186, 0.5345271386136915, 0.399209860032207, 0.6645258540348998, 0.33514172870806735, 0.23091854839364157, 0.8798905063975891, 0.7058575648465946, 0.6372685356584628, 0.3316398805362752, 0.9630911629743707, 0.11268350984788565, 0.3506083448228283, 0.8885985154262259, 0.7753802311826453, 0.7163605128341249, 0.6053577794923332, 0.5677291818413323, 0.5951343130389899, 0.15135003415560996, 0.9697886661691671, -0.040292080188500064, 0.7708284869795584, 0.6831670560488377, 0.29106605923365386, 0.9922848499005602, 0.9090640653530934, 1.2306275345035627, 0.34065326618985453, 0.07261755552080848, 0.6618817399089986, 0.032087506140550816, 0.28761854099930617, 1.0384749256153871, 0.2647791144303314, 0.25616960916202974, 0.7189786078779656, 0.678431573197943, 0.5292426951175955, 0.271087944614957, 0.4961877673519964, 0.059500214433283745, 0.5264308326236818, 0.4507506653694928, 0.1955146256663636, 0.6967986199534822, 0.8093807867406577, 0.1463579808124978, 0.6180780241466435, 0.7648779187168362, 0.4757670932767587, 0.04207743139096103, 0.8105618407366675, 0.7212498612926715, 0.17205276498988903, 0.9752569969410332, 0.794154505720922, 0.45027917258136807, 0.8984295000724504, 0.1841296707547544, 0.06093039786170084, 0.358879131812369, 0.9597562434424473, 0.07520052973104402, 0.32315952729333214, 0.8734499939408978, 0.20451503450369146, 0.9100086795730479, 0.523150092440525, -0.20623265531433613, 0.12953579364605147, 0.8209793279493031, -0.0817847146630898, 0.48313185677461, -0.3751728163141385, 0.12869877190045306, 0.9033122246637707, 0.09841133849610596, 0.7315324012690791, 0.4235002575849049, 0.8191587140587038, 0.7560863822557957, 0.5625176126282234, 0.6832035910141915, 1.0188296701144228, 0.20178442441852185, 0.5459530415398317, -0.5916185827431732, 0.6837383120127858, 0.5484920129683709, 0.6095466727955559, -0.6553270870544965, 0.5062598603554403, 0.3688735647285374, 0.6853433648083832, 0.5750146826137009, -0.15404173047313327, 0.40475558569417835, -0.229054852985109, -0.34925281034611455, -0.07241607824743723, -0.6026086324184857, 0.02282786667581803, 0.08414305078702759, -0.6962096706437856, 0.3900265843931603, -0.08477420385091458, 1.2275531526556798, -0.19574493175386576};
		double[] tp2 =  {0.8668706697828445, 0.8849612852264782, 0.614487434840942, 0.849005196835058, 0.4582486879396914, 0.45510557541259494, 0.07772340585043476, 0.831098593486189, 0.8811092441779956, 0.20829479624431507, 0.5175837379421931, 0.4452221959038698, 0.22150405170897097, 0.7487516698861368, 0.45041319338092856, 1.0072376974682522, 0.4992322990798546, 0.769719397226747, 0.4866678574460512, 0.2812426599225058, 0.6376857063118442, 0.5611199893312783, 1.0314992587400695, 0.43043231831902334, 0.7824815401711749, 1.1721144857411023, 0.8016477762057903, 1.1022328727572517, 0.7795807786215632, 0.6000340978779887, 0.29039034614581377, 0.3110368713035398, 0.3047544654592911, 1.1911281688820805, 0.7839519016410299, 0.1380604082416226, 0.2992644211752774, 0.42904565690304264, 0.7068449388878163, 0.6486259923536913, 0.6931118904892745, 0.8940747870098986, 0.09080555098307905, 0.6115867407477568, 0.9776317654623922, 0.7280013228195195, 0.15081611123403396, 0.5160937181896937, 0.5298133500583887, 0.5252256373522339, 0.8639783471598063, 0.9712676288524313, 0.09205689719199857, 0.22432888694884212, 0.9422766824976377, 0.6191555250900502, 0.2014393928639615, 0.006032776419965056, 0.4934646700175297, 0.341417725770708, 0.08686187351243514, 0.9632423996285673, 0.3279031278108945, 0.7200870189451115, 0.004664613201083862, 0.9659572028318898, 0.222336043152103, 0.757616840539814, 0.45185445359691545, 0.929754983800651, 0.1270236687542803, 0.3259274767977379, 1.02616698734116, 0.9973304592136252, 0.5466826698244077, 0.11808541644399863, 0.7127688139299948, 0.8721634189332896, 0.7326705402674578, 0.7753213726935116, 0.8402023346298195, 0.022175022204051396, -0.0863792903725431, 1.296347156560269, 0.44954620502212467, 0.33070004933877406, 0.07712187808766707, 0.37245906072229584, 0.5136389077312069, -0.17196489483178856, -0.21209444949398693, -0.2968091311346099, -0.14740923539584233, 0.11338203258957943, 0.5568357827651375, 0.7650363098941361, 0.1575525587639085, 1.0712562181559244, -0.31456935450291834, -0.5406216213803422, -0.4775890508873753, 0.41962472682043034, 0.6855032564862495, -0.7385737313780347, -0.04304868347007051, 0.4812991310748288, 0.17214202917043228, 0.37288711957027215, -0.2405120440003524, 0.7355670255604085, 0.3530679445172756, 0.5211577766606433, 0.40803306777561427, 0.6508357512373592, 0.03383344136029372, -0.5085105522896769, -0.1644463747084974, -0.5856647747013215, 0.8628404533778327, 1.064291745323617};
	;
		
		PongController controller = new PongController(new NNProperties("src/pong/pong.properties"));
//		controller.pongPlayers.get(0).getBrain().updateWeights(tp1);
//		controller.getPongPlayers().get(1).getBrain().updateWeights(tp2);
		PongFrame f = new PongFrame(controller.pongs);
		f.addKeyListener(controller);		
		controller.run();	
		
//		controller.getPongPlayers().forEach(p-> p.disable());
	}
	
}
